<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习越南语请联系Wx:XiDeYueNanYu</title>
    <style>
        body {
            background-color: #f6faf7;
            margin-bottom: 60px;
        }
        #infoBox { 
            width: 100%; 
            max-width: 700px;
            height: 100px; 
            margin: 0 auto; 
            border: 1px solid #88a5a2; 
            background: #6b8f8b; 
            color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 80px);
            font-weight: bold;
        }
        #contactBox { 
            width: 100%; 
            max-width: 700px;
            height: 45px; 
            margin: 0px auto; 
            border: 1px solid #88a5a2; 
            background: #6b8f8b; 
            color: #f4f8a6; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(12px, 2vw, 15px); 
            font-weight: bold;
        }
        .image-frame {
            max-width: 700px;
            margin: 20px auto 0 auto;
            border: 8px solid #88a5a2;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: none;
            overflow: hidden;
        }
        .image-frame img {
            width: 100%;
            height: auto;
            display: block;
        }
        .content-box {
            max-width: 700px;
            margin: 20px auto;
            padding: 50px;
            border: 8px solid #88a5a2;
            border-radius: 10px;
            background-color: #ffffff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 30px;
            font-family: Arial;
            color: #222322;
            line-height: 3;
            text-align: justify;
        }
        .translated-word {
            position: relative;
            display: inline-block;
            white-space: nowrap;
            line-height: 1.3;
            background-color: #e6f0e7;
            color: #000000;
            padding: 4px 4px;
            border-radius: 2px;
        }
        .translation {
            position: absolute;
            top: -29px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            background-color: #cfd8cf;
            color: #313a2d;
            padding: 4px 4px;
            border-radius: 1px;
            white-space: nowrap;
            z-index: 1;
            line-height: 1;
        }
        .original {
            display: inline;
            line-height: 1;
        }
		.floating-controls {
			position: fixed;
			/* Thay đổi từ top thành bottom */
			bottom: 80px; /* Khoảng cách từ cạnh dưới màn hình */
			right: 20px;  /* Khoảng cách từ cạnh phải màn hình */
			background-color: #f0f0f0;
			padding: 10px;
			border-radius: 5px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
			text-align: center;
			display: block;
			z-index: 1000;
		}
        #audioPlayer {
            width: 100%;
            margin-bottom: 10px;
        }
        .time-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .time-box-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .floating-controls p#timeDisplay {
            font-size: 28px;
            color: #FFFFFF;
            background-color: #000000;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0;
        }
        .floating-controls .time-box {
            font-size: 16px;
            color: #FFFFFF;
            background-color: #555555;
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 60px;
        }
        .tua-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .control-button {
            width: 50px;
            height: 50px;
            background-color: #363535;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        .control-button:disabled {
            background-color: #888888;
            cursor: not-allowed;
        }
        .control-button:hover:not(:disabled) {
            background-color: #000000;
        }
        .pause-play-button {
            background-color: #FF4500;
        }
        .pause-play-button:hover {
            background-color: #CC3700;
        }
        .toggle-button {
            background-color: #4682B4;
        }
        .toggle-button:hover {
            background-color: #36648B;
        }
        .loop-button {
            background-color: #3c923c;
        }
        .loop-button:hover {
            background-color: #347d34;
        }
        .clear-button {
            background-color: #bc3f13;
        }
        .clear-button:hover {
            background-color: #d15124;
        }
        .active {
            background-color: #ffffff; 
            border-radius: 5px;
        }
        @media (max-width: 400px) {
            .control-button {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }
            .floating-controls p#timeDisplay {
                font-size: 20px;
            }
            .floating-controls .time-box {
                font-size: 12px;
                min-width: 50px;
            }
        }
        #quizContainer {
            display: none;
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0px auto;
            padding: 10px;
            color: #88a5a2;
            font-size: 20px;
            font-weight: bold;
        }
        .question {
            margin-bottom: 20px;
            padding: 18px;
            color: #21292c;
            border: 5px solid #88a5a2;
            border-radius: 10px;
            background-color: #ffffff;
            font-size: 20px;
            font-weight: bold;
        }
        .options label {
            display: block;
            margin: 15px 0;
            cursor: pointer;
            color: #21292c;
            font-size: 16px;
            font-weight: bold;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            display: none;
            border: 5px solid #88a5a2;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            background-color: #ffffff;
            color: #007a33;
        }
        .wrong-answer {
            color: #f65936;
            margin: 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        #submitQuiz {
            font-family: Arial, sans-serif;
            padding: 10spx 20px;
			margin-bottom: 20px;
            border: 3px solid #88a5a2;
            background-color: #ff5a36;
            border-radius: 5px;
            color: #ffffff;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        #submitQuiz:hover {
            background-color: #ff844a;
        }
        .floating-mode-bar {
            position: fixed;
            bottom: 0px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #6b8f8b;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0px 5px rgba(0, 0, 0, 1);
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
            width: 900px;
        }
        .mode-button {
            padding: 10px 20px;
            border: 2px solid #c3d2d0;
            background: #d2dddc;
            color: #202a29;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            transition: border-color 0.5s;
        }
        .mode-button.active {
            border: 2px solid #ffffff;
            background: #f9f9f9;
            color: #202a29;
        }
        /* Mobile styles */
        @media (max-width: 768px) { 
            body {
                background-color: #f7fbf3;
                margin-bottom: 60px;
            }
            #infoBox { 
                width: 90%; 
                height: 120px; 
                margin: 0 auto; 
                border: 2px solid #88a5a2; 
                background: ##6b8f8b; 
                color: #ffffff; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 60px; 
                font-weight: bold;
            }
            #contactBox { 
                width: 90%; 
                height: 30px; 
                margin: 0px auto; 
                border: 2px solid #88a5a2; 
                background: ##6b8f8b; 
                color: #ffe599; 
                display: flex; 
                align-items: center; 
                justify-content: left; 
                padding-left: 20px;
                font-size: 16px; 
                font-weight: bold;
            }
            .image-frame {
                width: 90%;
                max-width: 700px;
                margin: 10 screen auto 0 auto;
                border: 5px solid #88a5a2;
                border-radius: 10px;
                background-color: #ffffff;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                display: none;
                overflow: hidden;
            }
            .image-frame img {
                width: 100%;
                height: auto;
                display: block;
            }
            .content-box {
                max-width: 700px;
                margin: 10px auto;
                padding: 20px;
                padding-top: 50px;
                padding-bottom: 90px;
                border: 5px solid #88a5a2;
                border-radius: 10px;
                background-color: #ffffff;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                font-size: 19px;
                font-family: Arial;
                color: #222322;
                line-height: 3.5;
                text-align: justify;
            }
            .translated-word {
                position: relative;
                display: inline-block;
                white-space: nowrap;
                line-height: 1.3;
                background-color: #e6f0e7;
                color: #222923;
                padding: 3px 3px;
                border-radius: 2px;
            }
            .translation {
                position: absolute;
                top: -25px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 13px;
                background-color: #cfd8cf;
                color: #222923;
                padding: 4px 4px;
                border-radius: 1px;
                white-space: nowrap;
                z-index: 1;
                line-height: 1;
            }
            .original {
                display: inline;
                line-height: 1;
            }
            .floating-controls {
                position: fixed;
                bottom: 80px;
                right: 20px;
                background-color: #f0f0f0;
                padding: 10px;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
                text-align: center;
                display: block;
                z-index: 1000;
            }
            #audioPlayer {
                width: 100%;
                margin-bottom: 10px;
            }
            .time-row {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }
            .time-box-group {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .button-group {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .floating-controls p#timeDisplay {
                font-size: 28px;
                color: #FFFFFF;
                background-color: #000000;
                padding: 5px 10px;
                border-radius: 5px;
                cursor: pointer;
                margin: 0;
            }
            .floating-controls .time-box {
                font-size: 16px;
                color: #FFFFFF;
                background-color: #555555;
                padding: 5px 10px;
                border-radius: 5px;
                min-width: 60px;
            }
            .tua-buttons {
                display: flex;
                justify-content: center;
                gap: 5px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            }
            .action-buttons {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .control-button {
                width: 50px;
                height: 50px;
                background-color: #363535;
                color: white;
                border: none;
                border-radius: 50%;
                font-size: 16px;
                font-weight: bold;
                cursor: pointer;
                display: inline-flex;
                justify-content: center;
                align-items: center;
            }
            .control-button:disabled {
                background-color: #888888;
                cursor: not-allowed;
            }
            .control-button:hover:not(:disabled) {
                background-color: #000000;
            }
            .pause-play-button {
                background-color: #FF4500;
            }
            .pause-play-button:hover {
                background-color: #CC3700;
            }
            .toggle-button {
                background-color: #4682B4;
            }
            .toggle-button:hover {
                background-color: #36648B;
            }
            .loop-button {
                background-color: #3c923c;
            }
            .loop-button:hover {
                background-color: #347d34;
            }
            .clear-button {
                background-color: #bc3f13;
            }
            .clear-button:hover {
                background-color: #d15124;
            }
            .active {
                background-color: #ffffff; 
                border-radius: 5px;
            }            
    </style>
    <!-- Thêm CSS cho chế độ từ vựng -->
    <style>
        #vocabContainer {
            display: none;
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #88a5a2;
            font-size: 20px;
            font-weight: bold;
        }
        .vocab-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        .nav-button {
            padding: 10px 20px;
            border: 2px solid #88a5a2;
            background-color: #d2dddc;
            color: #202a29;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }
        .nav-button:disabled {
            background-color: #888888;
            cursor: not-allowed;
        }
        #vocabProgress {
            font-size: 20px;
            color: #ff7f50;
        }
        .vocab-meaning {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #fed16a;
            border-radius: 30px;
            background-color: #ffffe0;
            font-size: 24px;
            color: #8aaf47;
        }
        #selectedLetters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            min-height: 120px;
            margin-bottom: 20px;
            padding: 3px;
            border: 2px solid #88a5a2;
            border-radius: 10px;
            background-color: #ffffff;
        }
        #availableLetters {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            border: 2px solid #88a5a2;
            border-radius: 10px;
            background-color: #ffffff;
        }
        .letter-button {
			width: 50px;              /* Cố định chiều rộng */
			height: 50px;             /* Cố định chiều cao */
			padding: 0;
            margin: 1px;
            background-color: #6b8f8b;
            color: #ffffff;
            border: none;
            border-radius: 5px;
            font-size: 25px;
            font-weight: bold;
            cursor: pointer;
        }
        .letter-button:hover:not(:disabled) {
            background-color: #000000;
        }
        .letter-button.space {
            background-color: #88a5a2;
            color: #ffffff;
        }
        .letter-button:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        #selectedLetters.correct {
            background-color: #d9ead3;
        }
        #selectedLetters.wrong {
            background-color: #e1a79e;
        }
    </style>
</head>
<body>
    <div id="infoBox">习得越南语</div>
    <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>
    <div id="contentContainer">
        <div class="image-frame" id="imageFrame">
            <img id="contentImage" src="" alt="Content Image">
        </div>
        <div class="content-box" id="content"></div>
    </div>
    <div id="quizContainer">
        <h1>回答下面问题</h1>
        <form id="quizForm">
            <div id="questions"></div>
            <button type="button" id="submitQuiz" onclick="checkAnswers()">提交</button>
        </form>
        <div id="result"></div>
    </div>
    <!-- Thêm container cho chế độ từ vựng -->
    <div id="vocabContainer">
        <div class="vocab-navigation">
            <button class="nav-button" id="prevVocab">◀</button>
            <span id="vocabProgress"></span>
            <button class="nav-button" id="nextVocab">▶</button>
        </div>
        <div class="vocab-meaning"><span id="vocabMeaning"></span></div>
        <div id="selectedLetters"></div>
        <div id="availableLetters"></div>
    </div>
    <div class="floating-controls" id="floatingControls">
        <audio id="audioPlayer" src="lesson.mp3" controls></audio>
        <div class="time-row">
            <p id="timeDisplay">00:00</p>
            <div class="time-box-group">
                <span class="time-box" id="loopStart">--:--</span>
                <span class="time-box" id="loopEnd">--:--</span>
            </div>
            <div class="button-group">
                <button class="control-button loop-button" id="loopButton">听</button>
                <button class="control-button clear-button" id="clearButton">删</button>
            </div>
        </div>
        <div class="tua-buttons">
            <button class="control-button" id="rewind5sButton">-5s</button>
            <button class="control-button" id="rewind1sButton">-1s</button>
            <button class="control-button" id="forward1sButton">+1s</button>
            <button class="control-button" id="forward5sButton">+5s</button>
        </div>
        <div class="action-buttons">
            <button class="control-button pause-play-button" id="pausePlayButton">播</button>
            <button class="control-button toggle-button" id="toggleControlsButton">藏</button>
        </div>
    </div>
    <div class="floating-mode-bar">
        <button class="mode-button active" id="contentMode">内容</button>
        <button class="mode-button" id="quizMode">回答问题</button>
        <button class="mode-button" id="vocabMode">词汇</button>
    </div>
    <!-- Thêm audio cho đúng/sai -->
    <audio id="correctAudio" src="Dung.mp3"></audio>
    <audio id="wrongAudio" src="Sai.mp3"></audio>

    <script>

const textContentData = [
    `SỰ MẾN KHÁCH CỦA NGƯỜI VIỆT NAM.
Người Việt Nam rất mến khách. Người nước ngoài nào đến Việt Nam cũng đều nhận thấy điều này. Từ người già đến người trẻ, từ phụ nữ đến nam giới, ngay cả trẻ em cũng rất vui vẻ và cởi mở với người nước ngoài.
Bạn có thể làm quen với người Việt Nam ở bất cứ nơi nào: trong quán bia, nhà hàng, ở hiệu sách, chợ, bến xe hay nhà ga... Người Việt Nam bắt chuyện với bạn rất tự nhiên và thoải mái.
Khi bạn đã quen thân với họ, họ sẽ mời bạn về nhà chơi. Các gia đình Việt Nam luôn mở rộng cửa đón bạn. Họ sẽ tiếp đón bạn như một vị khách quý. Họ sẽ mời bạn uống chè, ăn cơm, thưởng thức những đặc sản địa phương hoặc những món ăn đặc biệt do họ tự nấu, tự làm.
Trong thời gian sống ở đây, bạn hãy đến thăm các gia đình Việt Nam, bạn sẽ hiểu thêm về cuộc sống sinh hoạt của người Việt Nam.`
];
const dictionary = {
"sự mến khách": "好客",
"người Việt Nam": "越南人",
"người nước ngoài": "外国人",
"nhận thấy": "注意到",
"người già": "老人",
"người trẻ": "年轻人",
"phụ nữ": "女性",
"nam giới": "男性",
"trẻ em": "儿童",
"vui vẻ": "愉快",
"cởi mở": "开朗",
"làm quen": "认识",
"quán bia": "啤酒摊",
"nhà hàng": "餐厅",
"hiệu sách": "书店",
"chợ": "市场",
"bến xe": "车站",
"nhà ga": "火车站",
"bắt chuyện": "搭话",
"tự nhiên": "自然",
"thoải mái": "轻松",
"quen thân": "熟悉",
"mời": "邀请",
"nhà": "家",
"chơi": "玩",
"gia đình": "家庭",
"mở rộng cửa": "敞开大门",
"tiếp đón": "接待",
"vị khách quý": "贵宾",
"uống chè": "喝茶",
"ăn cơm": "吃饭",
"thưởng thức": "品尝",
"đặc sản": "特产",
"địa phương": "当地",
"món ăn": "菜肴",
"đặc biệt": "特别",
"nấu": "烹饪",
"làm": "制作",
"thời gian": "时间",
"sống": "生活",
"đến thăm": "拜访",
"hiểu": "了解",
"cuộc sống": "生活",
"sinh hoạt": "生活"
};
const quizData = [
    {
        question: "Theo bài đọc, điểm nào sau đây đúng với đặc điểm chung của người Việt Nam đối với người nước ngoài?",
        options: ["Chỉ người lớn mới cởi mở với người nước ngoài", "Người Việt thường dè dặt khi gặp người nước ngoài", "Tất cả các lứa tuổi đều vui vẻ và cởi mở với người nước ngoài", "Người Việt chỉ thân thiện với khách quen"],
        correct: "Tất cả các lứa tuổi đều vui vẻ và cởi mở với người nước ngoài"
    },
    {
        question: "Người Việt Nam thường làm gì khi đã quen thân với người nước ngoài?",
        options: ["Giới thiệu địa điểm du lịch nổi tiếng", "Tặng quà lưu niệm truyền thống", "Mời về nhà chơi và tiếp đãi như khách quý", "Mời tham dự các lễ hội địa phương"],
        correct: "Mời về nhà chơi và tiếp đãi như khách quý"
    },
    {
        question: "Theo bài, ở đâu người nước ngoài có thể dễ dàng làm quen với người Việt Nam?",
        options: ["Chỉ ở các khu du lịch", "Trong các lớp học tiếng Việt", "Ở bất kỳ nơi nào như quán bia, nhà ga, chợ...", "Tại các văn phòng chính quyền địa phương"],
        correct: "Ở bất kỳ nơi nào như quán bia, nhà ga, chợ..."
    },
    {
        question: "Việc người Việt mời bạn nước ngoài về nhà chơi thể hiện điều gì?",
        options: ["Tính cẩn trọng trong quan hệ cá nhân", "Sự hiếu khách và thân thiện", "Mong muốn học hỏi văn hóa phương Tây", "Sự tò mò với người nước ngoài"],
        correct: "Sự hiếu khách và thân thiện"
    },
    {
        question: "Theo tác giả, điều gì giúp người nước ngoài hiểu hơn về cuộc sống người Việt?",
        options: ["Đọc sách báo và tài liệu du lịch", "Tham gia các lớp học văn hóa", "Đến thăm gia đình Việt Nam", "Ở trong khách sạn và quan sát sinh hoạt địa phương"],
        correct: "Đến thăm gia đình Việt Nam"
    },
    {
        question: "Tác giả dùng giọng văn như thế nào khi miêu tả người Việt Nam?",
        options: ["Khách quan và trung lập", "Phê phán nhẹ nhàng", "Tán dương và tích cực", "Mỉa mai và hài hước"],
        correct: "Tán dương và tích cực"
    },
    {
        question: "Từ “mở rộng cửa đón bạn” trong ngữ cảnh bài đọc có nghĩa gần nhất với?",
        options: ["Luôn giữ nhà cửa thoáng mát", "Sẵn sàng tiếp khách đến nhà bất kỳ lúc nào", "Không khóa cửa khi có người đến", "Bắt buộc phải tiếp khách theo phong tục"],
        correct: "Sẵn sàng tiếp khách đến nhà bất kỳ lúc nào"
    },
    {
        question: "Điều gì không được đề cập đến trong cách người Việt tiếp đãi khách?",
        options: ["Mời ăn đặc sản địa phương", "Thưởng thức món do chủ nhà tự nấu", "Cùng đi du lịch khắp nơi", "Mời uống chè"],
        correct: "Cùng đi du lịch khắp nơi"
    },
    {
        question: "Theo bài, thái độ của trẻ em Việt Nam đối với người nước ngoài như thế nào?",
        options: ["Thụ động và rụt rè", "Chỉ chào hỏi nếu được người lớn yêu cầu", "Rất vui vẻ và cởi mở", "Không quan tâm đến người nước ngoài"],
        correct: "Rất vui vẻ và cởi mở"
    },
    {
        question: "Câu “Người Việt Nam bắt chuyện với bạn rất tự nhiên và thoải mái” hàm ý gì?",
        options: ["Người Việt có kỹ năng giao tiếp tốt", "Người Việt chủ yếu giao tiếp bằng ngôn ngữ cơ thể", "Giao tiếp không cần nhiều ngôn ngữ", "Người Việt thân thiện và dễ làm quen"],
        correct: "Người Việt thân thiện và dễ làm quen"
    },
    {
        question: "Việc nhấn mạnh đến “ở bất cứ nơi nào” trong đoạn 2 nhằm mục đích gì?",
        options: ["So sánh với các quốc gia khác", "Chứng minh người Việt thích đi nhiều nơi", "Làm nổi bật tính phổ biến và dễ tiếp cận trong giao tiếp", "Phản ánh sự thiếu riêng tư trong xã hội Việt Nam"],
        correct: "Làm nổi bật tính phổ biến và dễ tiếp cận trong giao tiếp"
    },
    {
        question: "Mục đích chính của bài viết là gì?",
        options: ["Phân tích tính cách của người Việt qua các thế hệ", "Hướng dẫn người nước ngoài cách giao tiếp ở Việt Nam", "Miêu tả sự thân thiện và mến khách của người Việt Nam", "So sánh văn hóa tiếp khách của Việt Nam và các nước khác"],
        correct: "Miêu tả sự thân thiện và mến khách của người Việt Nam"
    }
];

        // Xử lý hiển thị văn bản với từ điển
        const content = document.getElementById('content');
        function renderText() {
            let html = textContentData[0].replace(/\n/g, "<br>");
            const sortedKeys = Object.keys(dictionary).sort((a, b) => b.length - a.length);
            const replacements = [];

            // Bước 1: Tìm và lưu trữ các cụm từ khớp
            sortedKeys.forEach(key => {
                const regex = new RegExp(`(\\b|[.,!?\\n\\s]|^)(${key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})(\\b|[.,!?\\n\\s]|$)`, 'gi');
                let match;
                while ((match = regex.exec(html)) !== null) {
                    const start = match.index + match[1].length;
                    const end = start + match[2].length;
                    replacements.push({
                        start,
                        end,
                        original: match[2],
                        prefix: match[1],
                        suffix: match[3],
                        translation: dictionary[key]
                    });
                }
            });

            // Bước 2: Sắp xếp các lần khớp theo vị trí bắt đầu (start)
            replacements.sort((a, b) => a.start - b.start);

            // Bước 3: Lọc các lần khớp để loại bỏ chồng lấn
            const filteredReplacements = [];
            let lastEnd = -1;
            for (const replacement of replacements) {
                if (replacement.start >= lastEnd) {
                    filteredReplacements.push(replacement);
                    lastEnd = replacement.end;
                }
            }

            // Bước 4: Thay thế các cụm từ đã khớp, từ phải sang trái để tránh ảnh hưởng chỉ số
            for (let i = filteredReplacements.length - 1; i >= 0; i--) {
                const { start, end, original, prefix, suffix, translation } = filteredReplacements[i];
                const translatedHtml = `${prefix}<span class="translated-word"><span class="translation">${translation}</span><span class="original">${original}</span></span>${suffix}`;
                html = html.slice(0, start - prefix.length) + translatedHtml + html.slice(end + suffix.length);
            }

            content.innerHTML = html;
        }

        // Xử lý hiển thị ảnh
        const imageFrame = document.getElementById('imageFrame');
        const contentImage = document.getElementById('contentImage');
        const imageSrc = "anhminhhoa.jpg"; // Tên file ảnh cụ thể trong cùng thư mục
        function renderImage() {
            if (imageSrc) {
                contentImage.src = imageSrc;
                imageFrame.style.display = 'block';
            } else {
                imageFrame.style.display = 'none';
            }
        }

        // Gọi hàm renderText và renderImage khi khởi tạo
        renderText();
        renderImage();

        // Xử lý audio và bảng điều khiển
        const audioPlayer = document.getElementById("audioPlayer");
        const floatingControls = document.getElementById("floatingControls");
        const timeDisplay = floatingControls.querySelector("#timeDisplay");
        const loopStart = floatingControls.querySelector("#loopStart");
        const loopEnd = floatingControls.querySelector("#loopEnd");
        const loopButton = floatingControls.querySelector("#loopButton");
        const clearButton = floatingControls.querySelector("#clearButton");
        const rewind5sButton = floatingControls.querySelector("#rewind5sButton");
        const rewind1sButton = floatingControls.querySelector("#rewind1sButton");
        const forward1sButton = floatingControls.querySelector("#forward1sButton");
        const forward5sButton = floatingControls.querySelector("#forward5sButton");
        const pausePlayButton = floatingControls.querySelector("#pausePlayButton");
        const toggleControlsButton = floatingControls.querySelector("#toggleControlsButton");
        const tuaButtons = floatingControls.querySelector(".tua-buttons");

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay(displayElement) {
            displayElement.textContent = formatTime(audioPlayer.currentTime);
        }

        let customLoopStart = null;
        let customLoopEnd = null;
        let clickCount = 0;
        let isLooping = false;

        const updateInterval = setInterval(() => updateTimeDisplay(timeDisplay), 1000);

        audioPlayer.ontimeupdate = function() {
            updateTimeDisplay(timeDisplay);
            if (isLooping && customLoopStart !== null && customLoopEnd !== null) {
                if (audioPlayer.currentTime >= customLoopEnd) {
                    audioPlayer.currentTime = customLoopStart;
                }
            }
        };

        timeDisplay.onclick = () => {
            if (audioPlayer.paused) {
                clickCount++;
                if (clickCount === 1) {
                    customLoopStart = audioPlayer.currentTime;
                    loopStart.textContent = formatTime(customLoopStart);
                } else if (clickCount === 2) {
                    customLoopEnd = audioPlayer.currentTime;
                    if (customLoopEnd <= customLoopStart) {
                        customLoopEnd = null;
                        loopEnd.textContent = "--:--";
                    } else {
                        loopEnd.textContent = formatTime(customLoopEnd);
                    }
                    clickCount = 0;
                }
            }
        };

        rewind5sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5);
                updateTimeDisplay(timeDisplay);
            }
        };
        rewind1sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 1);
                updateTimeDisplay(timeDisplay);
            }
        };
        forward1sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 1);
                updateTimeDisplay(timeDisplay);
            }
        };
        forward5sButton.onclick = () => {
            if (!isLooping) {
                audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5);
                updateTimeDisplay(timeDisplay);
            }
        };

        pausePlayButton.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                pausePlayButton.textContent = "停";
            } else {
                audioPlayer.pause();
                pausePlayButton.textContent = "播";
            }
        };

        loopButton.onclick = () => {
            if (customLoopStart !== null && customLoopEnd !== null) {
                audioPlayer.currentTime = customLoopStart;
                audioPlayer.play();
                isLooping = true;
                rewind5sButton.disabled = true;
                rewind1sButton.disabled = true;
                forward1sButton.disabled = true;
                forward5sButton.disabled = true;
            }
        };

        clearButton.onclick = () => {
            customLoopStart = null;
            customLoopEnd = null;
            loopStart.textContent = "--:--";
            loopEnd.textContent = "--:--";
            clickCount = 0;
            isLooping = false;
            rewind5sButton.disabled = false;
            rewind1sButton.disabled = false;
            forward1sButton.disabled = false;
            forward5sButton.disabled = false;
        };

        let controlsVisible = true;
        toggleControlsButton.onclick = () => {
            if (controlsVisible) {
                timeDisplay.style.display = "none";
                tuaButtons.style.display = "none";
                pausePlayButton.style.display = "none";
                loopStart.style.display = "none";
                loopEnd.style.display = "none";
                loopButton.style.display = "none";
                clearButton.style.display = "none";
                toggleControlsButton.textContent = "示";
                controlsVisible = false;
            } else {
                timeDisplay.style.display = "inline-block";
                tuaButtons.style.display = "flex";
                pausePlayButton.style.display = "inline-flex";
                loopStart.style.display = "inline-block";
                loopEnd.style.display = "inline-block";
                loopButton.style.display = "inline-flex";
                clearButton.style.display = "inline-flex";
                toggleControlsButton.textContent = "藏";
                controlsVisible = true;
            }
        };

        audioPlayer.onpause = audioPlayer.onended = function() {
            pausePlayButton.textContent = "播";
        };

        // Biến lưu trữ vị trí cuộn và lựa chọn
        let contentScrollPosition = 0;
        let quizScrollPosition = 0;
        let userSelections = {};
        let isSubmitted = false;

        // Hiển thị câu hỏi và khôi phục lựa chọn
        function loadQuiz() {
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = '';
            quizData.forEach((item, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                
                const questionTitle = document.createElement('h3');
                questionTitle.textContent = `Câu ${index + 1}: ${item.question}`;
                questionDiv.appendChild(questionTitle);

                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'options';
                
                item.options.forEach(option => {
                    const label = document.createElement('label');
                    const isChecked = userSelections[`question${index}`] === option ? 'checked' : '';
                    label.innerHTML = `
                        <input type="radio" name="question${index}" value="${option}" ${isChecked}>
                        ${option}
                    `;
                    optionsDiv.appendChild(label);
                });

                questionDiv.appendChild(optionsDiv);
                questionsDiv.appendChild(questionDiv);
            });

            // Khôi phục vị trí cuộn
            window.scrollTo(0, quizScrollPosition);
        }

        // Lưu lựa chọn của người dùng
        function saveSelections() {
            quizData.forEach((_, index) => {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                if (selected) {
                    userSelections[`question${index}`] = selected.value;
                }
            });
        }

        // Kiểm tra đáp án
        function checkAnswers() {
            let score = 0;
            const total = quizData.length;
            let wrongAnswers = [];
            
            quizData.forEach((item, index) => {
                const selected = document.querySelector(`input[name="question${index}"]:checked`);
                if (selected) {
                    if (selected.value === item.correct) {
                        score++;
                    } else {
                        wrongAnswers.push({
                            question: item.question,
                            selected: selected.value,
                            correct: item.correct
                        });
                    }
                } else {
                    wrongAnswers.push({
                        question: item.question,
                        selected: "未选择",
                        correct: item.correct
                    });
                }
            });

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `
                <h3>YD-Visa-结果: ${score}/${total} 答案正确</h3>
                <p>比例: ${(score/total * 100).toFixed(2)}%</p>
            `;

            if (wrongAnswers.length > 0) {
                resultDiv.innerHTML += '<h4>错误答案:</h4>';
                wrongAnswers.forEach((wrong, index) => {
                    resultDiv.innerHTML += `
                        <div class="wrong-answer">
                            Câu ${quizData.findIndex(q => q.question === wrong.question) + 1}: ${wrong.question}<br>
                            你的选择: ${wrong.selected} - 正确答案: ${wrong.correct}
                        </div>
                    `;
                });
            } else {
                resultDiv.innerHTML += '<p>回答正确所有问题</p>';
            }

            resultDiv.scrollIntoView({ behavior: 'smooth' });
            isSubmitted = true; // Đánh dấu đã nộp bài
        }

        // Xử lý chế độ hiển thị
        const contentModeButton = document.getElementById('contentMode');
        const quizModeButton = document.getElementById('quizMode');
        const vocabModeButton = document.getElementById('vocabMode');
        const contentContainer = document.getElementById('contentContainer');
        const quizContainer = document.getElementById('quizContainer');
        const vocabContainer = document.getElementById('vocabContainer');

        contentModeButton.addEventListener('click', () => {
            // Lưu vị trí cuộn của quiz trước khi chuyển
            quizScrollPosition = window.scrollY;
            saveSelections(); // Lưu lựa chọn của người dùng
            
            contentContainer.style.display = 'block';
            quizContainer.style.display = 'none';
            vocabContainer.style.display = 'none';
            contentModeButton.classList.add('active');
            quizModeButton.classList.remove('active');
            vocabModeButton.classList.remove('active');
            floatingControls.style.display = 'block';
            renderText();
            renderImage();
            
            // Khôi phục vị trí cuộn của content
            window.scrollTo(0, contentScrollPosition);
        });

        quizModeButton.addEventListener('click', () => {
            // Lưu vị trí cuộn của content trước khi chuyển
            contentScrollPosition = window.scrollY;
            saveSelections(); // Lưu lựa chọn của người dùng
            
            contentContainer.style.display = 'none';
            quizContainer.style.display = 'block';
            vocabContainer.style.display = 'none';
            quizModeButton.classList.add('active');
            contentModeButton.classList.remove('active');
            vocabModeButton.classList.remove('active');
            floatingControls.style.display = 'none';
            
            // Reset lựa chọn nếu đã nộp bài
            if (isSubmitted) {
                userSelections = {};
                isSubmitted = false;
            }
            
            loadQuiz();
        });

        // Thêm logic cho chế độ từ vựng
        const vocabList = Object.keys(dictionary);
        let currentVocabIndex = 0;
        let selectedIndices = []; // Mảng index từ availableLettersArray đã chọn, theo thứ tự
        let availableLettersArray = [];
        const selectedLettersDiv = document.getElementById('selectedLetters');
        const availableLettersDiv = document.getElementById('availableLetters');
        const vocabMeaning = document.getElementById('vocabMeaning');
        const vocabProgress = document.getElementById('vocabProgress');
        const prevVocab = document.getElementById('prevVocab');
        const nextVocab = document.getElementById('nextVocab');
        const correctAudio = document.getElementById('correctAudio');
        const wrongAudio = document.getElementById('wrongAudio');

        function loadVocab() {
            const word = vocabList[currentVocabIndex];
            availableLettersArray = word.split('').sort(() => Math.random() - 0.5); // Đảo loạn và cố định
            vocabMeaning.textContent = dictionary[vocabList[currentVocabIndex]];
            vocabProgress.textContent = `${currentVocabIndex + 1}/${vocabList.length}`;
            selectedIndices = [];
            renderLetters();

            prevVocab.disabled = currentVocabIndex === 0;
            nextVocab.disabled = currentVocabIndex === vocabList.length - 1;
        }

        function renderLetters() {
            selectedLettersDiv.innerHTML = '';
            availableLettersDiv.innerHTML = '';
            selectedLettersDiv.classList.remove('correct', 'wrong');

            // Render selected letters
            selectedIndices.forEach((availIndex, selIndex) => {
                const letter = availableLettersArray[availIndex];
                const btn = createLetterButton(letter, () => removeFromSelected(selIndex));
                selectedLettersDiv.appendChild(btn);
            });

            // Render available letters (fixed positions)
            availableLettersArray.forEach((letter, availIndex) => {
                const isSelected = selectedIndices.includes(availIndex);
                const btn = createLetterButton(letter, isSelected ? null : () => addToSelected(availIndex));
                if (isSelected) {
                    btn.disabled = true;
                }
                availableLettersDiv.appendChild(btn);
            });
        }

        function createLetterButton(letter, onClick) {
            const btn = document.createElement('button');
            btn.className = 'letter-button';
            btn.textContent = letter === ' ' ? ' ' : letter; // Sử dụng ký tự biểu tượng cho khoảng trắng
            if (letter === ' ') {
                btn.classList.add('space');
            }
            if (onClick) {
                btn.onclick = onClick;
            } else {
                btn.disabled = true;
            }
            return btn;
        }

        function addToSelected(availIndex) {
            selectedIndices.push(availIndex);
            renderLetters();
            checkIfComplete();
        }

        function removeFromSelected(selIndex) {
            selectedIndices.splice(selIndex, 1);
            renderLetters();
        }

        function checkIfComplete() {
            const word = vocabList[currentVocabIndex];
            const selectedWord = selectedIndices.map(i => availableLettersArray[i]).join('');
            if (selectedIndices.length === word.length) {
                if (selectedWord === word) {
                    selectedLettersDiv.classList.add('correct');
                    correctAudio.play();
                    setTimeout(() => {
                        if (currentVocabIndex < vocabList.length - 1) {
                            currentVocabIndex++;
                            loadVocab();
                        }
                    }, 1500);
                } else {
                    selectedLettersDiv.classList.add('wrong');
                    wrongAudio.play();
                    setTimeout(() => {
                        selectedIndices = [];
                        renderLetters();
                    }, 1500);
                }
            }
        }

        prevVocab.addEventListener('click', () => {
            if (currentVocabIndex > 0) {
                currentVocabIndex--;
                loadVocab();
            }
        });

        nextVocab.addEventListener('click', () => {
            if (currentVocabIndex < vocabList.length - 1) {
                currentVocabIndex++;
                loadVocab();
            }
        });

        vocabModeButton.addEventListener('click', () => {
            contentContainer.style.display = 'none';
            quizContainer.style.display = 'none';
            vocabContainer.style.display = 'block';
            vocabModeButton.classList.add('active');
            contentModeButton.classList.remove('active');
            quizModeButton.classList.remove('active');
            floatingControls.style.display = 'none';
            loadVocab();
        });

        // Mặc định hiển thị nội dung
        contentContainer.style.display = 'block';
        quizContainer.style.display = 'none';
        vocabContainer.style.display = 'none';
    </script>
</body>
</html>