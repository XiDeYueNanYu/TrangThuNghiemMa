<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hội Thoại</title>
    <style>
        :root {
            --color1: #fbfbfb;
            --color3: #393535;
            --color4: #fbfbfb;
            --color12: #393535;
            --structure-bg: rgba(254,156,4,0.5);
            
            --padding-top: 100px;
            --padding-bottom: 100px;
            --padding-left: 60px;
            --padding-right: 60px;

            --title-font-size: 90px;
            --title-color: #393535;
            --neirong-line-height: 2.2;
            
            --character-column-width: 150px;
            --char-box-height: 1.2;

            /* 2 thông số điều chỉnh khoảng cách nội dung */
            --content-top-margin: 10px;     /* Khoảng cách từ nội dung đến lề trên (sau phần tiêu đề) */
            --content-bottom-margin: 300px;  /* Khoảng cách từ nội dung đến lề dưới */

            /* Thông số điều chỉnh vị trí audio controls so với chân trang */
            --audio-bottom-position: 80px;  /* Khoảng cách từ đáy trang lên */
        }

        body {
            background-color: #1a1a1a;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding-bottom: 80px;
        }

        #infoBox { 
            width: 100%; 
            max-width: 800px;
            height: 150px; 
            margin: 0 auto 5px auto; 
            border: 1px solid #68838B; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: clamp(40px, 5vw, 90px);
            font-weight: bold;
        }

        #contactBox { 
            width: 100%; 
            max-width: 800px;
            height: 45px; 
            margin: 0 auto 5px auto; 
            border: 1px solid #68838B; 
            background: #68838B; 
            color: #D2B48C; 
            display: flex; 
            align-items: center; 
            justify-content: left; 
            padding-left: 20px;
            font-size: clamp(12px, 2vw, 25px); 
            font-weight: bold;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
            margin-top: var(--content-top-margin);
            margin-bottom: var(--content-bottom-margin);
        }

        .text-box {
            width: 100%;
            max-width: 1500px;
            padding: var(--padding-top) var(--padding-right) var(--padding-bottom) var(--padding-left);
            border: 10px solid var(--color1);
            background-color: var(--color4);
            font-size: 50px;
            color: var(--color3);
            line-height: var(--neirong-line-height);
            text-align: justify;
            box-sizing: border-box;
        }

        .title {
            font-size: var(--title-font-size);
            font-weight: bold;
            color: var(--title-color);
            text-align: center;
            margin-bottom: 30px;
            display: block;
            line-height: 1;
        }

        .dialogue-grid {
            display: grid;
            grid-template-columns: var(--character-column-width) 1fr;
            gap: 40px;
            margin-bottom: 25px;
            align-items: start;
            width: 100%;
        }

        .dialogue-content {
            text-align: left;
            padding-top: 5px; 
        }
        
        .character-box {
            display: flex;
            justify-content: flex-end; 
            align-items: center;   
            line-height: 1.2;    
            width: 100%;
            height: auto;
            padding-top: 35px;
        }

        .character-name {
            padding: 2px 15px; 
            border: 5px solid rgba(73,121,107,0.4);
            border-radius: 15px;
            font-weight: bold;
            font-size: 30px;
            line-height: 1.2;
            display: inline-block; 
            vertical-align: middle;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .character-name:hover {
            transform: scale(1.02);
            box-shadow: 0 0 10px rgba(73,121,107,0.6);
        }

        .character-name.playing {
            background-color: #ffcc00 !important;
            box-shadow: 0 0 15px rgba(255,204,0,0.8);
        }

        .colon {
            font-weight: bold;
            font-size: 35px;
            margin-left: 10px; 
            margin-right: 5px; 
            line-height: 1.2;
        }

        .translated-word {
            position: relative;
            display: inline-block;
            margin-top: 0px;
            background-color: rgba(167,187,174,0.3);
            padding: 3px 3px;
            border-radius: 8px;
            line-height: 1.2;
        }

        .annotation-top {
            position: absolute;
            top: -38px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 25px;
            color: var(--color12);
            background-color: rgba(167,187,174,0.7);
            padding: 5px 10px;
            border-radius: 8px;
            white-space: nowrap;
            line-height: 1;
            font-weight: normal;
        }

        .structure-main {
            background-color: var(--structure-bg);
            padding: 2px 10px;
            border-radius: 8px;
        }

        .structure-dependent {
            border-bottom: 10px solid var(--structure-bg);
            padding-bottom: 0px;
        }

        /* Thanh điều khiển audio - góc dưới bên phải */
        .floating-controls {
            position: fixed;
            bottom: var(--audio-bottom-position);
            right: 20px;
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: block;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        #audioPlayer {
            width: 100%;
            margin-bottom: 10px;
        }

        .time-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .time-box-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .floating-controls p#timeDisplay {
            font-size: 28px;
            color: #FFFFFF;
            background-color: #000000;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0;
        }

        .floating-controls .time-box {
            font-size: 16px;
            color: #FFFFFF;
            background-color: #555555;
            padding: 5px 10px;
            border-radius: 5px;
            min-width: 60px;
        }

        .tua-buttons {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .control-button {
            width: 50px;
            height: 50px;
            background-color: #363535;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .control-button:disabled {
            background-color: #888888;
            cursor: not-allowed;
        }

        .control-button:hover:not(:disabled) {
            background-color: #000000;
        }

        .pause-play-button {
            background-color: #FF4500;
        }

        .pause-play-button:hover {
            background-color: #CC3700;
        }

        .toggle-button {
            background-color: #4682B4;
        }

        .toggle-button:hover {
            background-color: #36648B;
        }

        .loop-button {
            background-color: #3c923c;
        }

        .loop-button:hover {
            background-color: #347d34;
        }

        .clear-button {
            background-color: #bc3f13;
        }

        .clear-button:hover {
            background-color: #d15124;
        }

        /* Thanh lựa chọn chế độ */
        .floating-mode-bar {
            position: fixed;
            bottom: 0;
            min-width: 800px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #68838B;
            padding: 10px;
            border-radius: 0;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            gap: 20px;
            z-index: 1000;
        }

        .mode-button {
            padding: 12px 24px;
            border: 0 solid #ccc;
            background: #95a8ad;
            color: #293437;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            min-width: 120px;
            transition: all 0.3s;
        }

        .mode-button.active {
            border: 3px solid #ffffff;
            background: #f0f0f0;
            color: #293437;
        }

        /* Quiz Container */
        #quizContainer {
            display: none;
            font-family: Arial, sans-serif;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 15px;
            box-sizing: border-box;
        }

        #quizInstructions {
            font-size: 24px;
            color: #ffffff;
            background-color: #68838B;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            line-height: 1.5;
        }

        .question {
            margin-bottom: 18px;
            padding: 16px;
            color: #53686f;
            border: 5px solid #53686f;
            border-radius: 10px;
            background-color: #ffffff;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .question.selected {
            background-color: #B7D7AA;
        }

        #result {
            margin-top: 30px;
            padding: 20px;
            display: none;
            border: 5px solid #53686f;
            border-radius: 10px;
            font-size: 20px;
            font-weight: bold;
            background-color: #ffffff;
            color: #007a33;
            line-height: 1.8;
        }

        .wrong-answer {
            color: #f65936;
            margin: 12px 0;
            font-size: 18px;
        }

        #submitQuiz {
            padding: 12px 24px;
            border: 3px solid #53686f;
            background-color: #FF6820;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: block;
            margin: 30px auto;
        }

        #submitQuiz:hover {
            background-color: #ff844a;
        }

        /* Tắt highlight khi chạm trên mobile */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        .control-button,
        .mode-button,
        #submitQuiz,
        .question {
            -webkit-appearance: none;
            outline: none;
            -webkit-user-select: none;
            user-select: none;
        }

        .control-button:active,
        .mode-button:active,
        #submitQuiz:active,
        .question:active {
            opacity: 0.7;
            transform: scale(0.95);
            transition: all 0.1s ease;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            :root {
                --padding-top: 40px;
                --padding-bottom: 40px;
                --padding-left: 20px;
                --padding-right: 20px;
                --title-font-size: 50px;
                --neirong-line-height: 2.6;
                --character-column-width: 80px;
                --audio-bottom-position: 70px;
            }
			#infoBox { 
			width: 95%;
            height: 100px; 
			font-size: clamp(60px, 5vw, 90px);
			}
			#contactBox { 
            width: 93%; 
            height: 45px; 
            font-size: clamp(18px, 2vw, 25px); 
            font-weight: bold;
			}
            .text-box {
                font-size: 20px;
                padding: 30px 15px;
                border-width: 6px;
            }

            .title {
                font-size: 30px;
                margin-bottom: 20px;
            }

            .character-name {
                font-size: 16px;
                padding: 4px 10px;
                border-width: 4px;
            }

            .colon {
                font-size: 16px;
                margin-left: 3px;
                margin-right: 3px;
            }

            .annotation-top {
                font-size: 13px;
                top: -20px;
                padding: 2px 2px;
                border-radius: 1px;
            }

            .dialogue-grid {
                gap: 5px;
                margin-bottom: 20px;
            }

            .character-box {
                padding-top: 11px;
            }

            .floating-controls {
                padding: 8px;
            }

            .control-button {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .floating-controls p#timeDisplay {
                font-size: 22px;
                padding: 4px 8px;
            }

            .floating-controls .time-box {
                font-size: 13px;
                min-width: 50px;
                padding: 4px 8px;
            }

            .floating-mode-bar {
                width: 90%;
                min-width: 100px;
                padding: 8px;
                gap: 15px;
            }

            .mode-button {
                padding: 10px 18px;
                font-size: 18px;
                min-width: 100px;
            }

            #quizInstructions {
                font-size: 20px;
                padding: 10px;
            }

            .question {
                font-size: 18px;
                padding: 14px;
                border-width: 4px;
            }

            #result {
                font-size: 18px;
                padding: 15px;
            }

            #submitQuiz {
                padding: 10px 20px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div id="infoBox">习得越南语</div>
    <div id="contactBox">讲师-阮玉煌 | Weixin：XiDeYueNanYu</div>

    <div class="container" id="dialogueContainer">
        <div class="text-box" id="textDisplay"></div>
    </div>

    <div id="quizContainer">
        <div id="quizInstructions">请点击您认为正确的句子（点击一次表示“正确”，再点取消），不点击则表示“错误”。<br>完成后点击“提交”查看结果。</div>
        <div id="questions"></div>
        <button type="button" id="submitQuiz">提交</button>
        <div id="result"></div>
    </div>

    <!-- Thanh điều khiển audio - góc dưới bên phải -->
    <div class="floating-controls" id="floatingControls">
        <audio id="audioPlayer" src="hoithoai.mp3" controls></audio>
        <div class="time-row">
            <p id="timeDisplay">00:00</p>
            <div class="time-box-group">
                <span class="time-box" id="loopStart">--:--</span>
                <span class="time-box" id="loopEnd">--:--</span>
            </div>
            <div class="button-group">
                <button class="control-button loop-button" id="loopButton">听</button>
                <button class="control-button clear-button" id="clearButton">删</button>
            </div>
        </div>
        <div class="tua-buttons">
            <button class="control-button" id="rewind5sButton">-5s</button>
            <button class="control-button" id="rewind1sButton">-1s</button>
            <button class="control-button" id="forward1sButton">+1s</button>
            <button class="control-button" id="forward5sButton">+5s</button>
        </div>
        <div class="action-buttons">
            <button class="control-button pause-play-button" id="pausePlayButton">播</button>
            <button class="control-button toggle-button" id="toggleControlsButton">藏</button>
        </div>
    </div>

    <!-- Thanh lựa chọn chế độ -->
    <div class="floating-mode-bar">
        <button class="mode-button active" id="dialogueMode">会话</button>
        <button class="mode-button" id="quizMode">回答问题</button>
    </div>

    <script>
        const text = `
B1
┋David:┋ Chào Lauren. Lâu lắm rồi mới gặp chị.
┋Lauren:┋ Ô, chào David. Chị mới ở Việt Nam về. Em sắp tốt nghiệp chưa?
┋David:┋ Chưa. Em còn hai năm nữa. Em định sang Việt Nam học. Tiếng Việt của em chưa tốt lắm nên em muốn đến Hà Nội học một năm rồi về Mỹ học tiếp.
┋Lauren:┋ Ừ. Em nên đi. Ở đó một năm chắc em sẽ tiến bộ nhiều.
┋David:┋ Chị ơi. Em chưa đi Việt Nam bao giờ. Thủ tục thế nào ạ?
┋Lauren:┋ Chị còn giữ mẫu đơn đây. Nhưng tốt nhất là em vào website của Viện Phát triển Ngôn ngữ xem rồi làm theo hướng dẫn.
┋David:┋ Cho em xem mẫu đơn. Có phức tạp lắm không?
┋Lauren:┋ Không. Đơn giản lắm. Em chỉ cần điền vào đơn xin học và đơn xin visa thôi. Trong website có tất cả thông tin về các khóa học nữa, em có thể chọn lớp.
┋David:┋ Thế ạ. Vậy thì tốt quá!
┋Lauren:┋ Chị đã học ở đó một thời gian. Chương trình học ở đó thú vị lắm.
┋David:┋ Thế thì em sẽ xem và liên lạc ngay với Viện Phát triển Ngôn ngữ. Cám ơn chị nhiều.`;

        const characterMap = {
            "David": "#e8efea",
            "Lauren": "#bad0c2",
            "Mẹ": "#ffe288"
        };

        const dialogueTimings = [
            { character: "David", start: 0, end: 3 },
            { character: "Lauren", start: 3, end: 8 },
            { character: "David", start: 8, end: 18 },
            { character: "Lauren", start: 18, end: 24 },
            { character: "David", start: 24, end: 29 },
            { character: "Lauren", start: 29, end: 38 },
            { character: "David", start: 38, end: 42 },
            { character: "Lauren", start: 42, end: 50 },
            { character: "David", start: 50, end: 53 },
            { character: "Lauren", start: 53, end: 58 },
            { character: "David", start: 58, end: 65 }
        ];

        const dictionary = {
            "mới@ gặp chị": "才",
            "mới@ ở Việt Nam": "刚刚",
            "sắp": "快，即将",
            "tốt nghiệp": "毕业",
            "còn": "还有",
            "còn@ giữ mẫu đơn": "还",
            "định": "打算",
            "nên@ em muốn": "所以",
            "nên@ đi": "应该",
            "rồi@ về Mỹ": "然后",
            "rồi@ làm theo": "然后",
            "chắc": "也许",
            "tiến bộ": "进步",
            "Thủ tục": "手续",
            "giữ": "留着",
            "mẫu đơn": "申请表",
            "phức tạp": "复杂",
            "Đơn giản": "简单",
            "cần": "需要",
            "điền": "填写",
            "đơn xin học": "入学申请",
            "đơn xin visa": "签证申请",
            "thông tin": "信息",
            "các khóa học": "课程",
            "chọn": "选择",
            "Chương trình học": "教学计划",
            "thú vị": "有趣",
            "liên lạc": "联系",
            "ngay": "马上"
        };

        const quizData = [
            { question: "David đã tốt nghiệp đại học.", correct: false },
            { question: "David định học tiếng Việt ở Hà Nội trong một năm.", correct: true },
            { question: "Lauren mới từ Mỹ về.", correct: false },
            { question: "Thủ tục xin visa rất phức tạp.", correct: false },
            { question: "David cần điền đơn xin học và đơn xin visa.", correct: true },
            { question: "Chương trình học ở Viện Phát triển Ngôn ngữ rất nhàm chán.", correct: false },
            { question: "David đã từng đi Việt Nam trước đây.", correct: false },
            { question: "Lauren còn giữ mẫu đơn xin học.", correct: true },
            { question: "David sẽ liên lạc ngay với Viện Phát triển Ngôn ngữ.", correct: true },
            { question: "Có thể chọn lớp học trên website của viện.", correct: true }
        ];

        let currentDialogueIndex = 0;
        let dialogueElements = [];
        let userSelections = {};

        function renderText(rawText) {
            let lines = rawText.trim().split('\n');
            let outputHtml = '';

            if (lines.length > 0) {
                outputHtml += `<div class="title">${lines[0]}</div>`;
            }

            for (let i = 1; i < lines.length; i++) {
                let line = lines[i].trim();
                if (!line) continue;

                const charMatch = line.match(/┋(.*?):┋/);
                let charName = charMatch ? charMatch[1] : "";
                let content = line.replace(/┋.*?:┋/, "").trim();

                content = applyDictionary(content);

                content = content.replace(/╠(.*?)╣/g, (m, c) => {
                    return c.replace(/(.*?)(┝[^┝┥]*┥|$)/g, (im, dep, main) => {
                        let res = '';
                        if (dep) res += `<span class="structure-dependent">${dep}</span>`;
                        if (main) res += `<span class="structure-main">${main.slice(1, -1)}</span>`;
                        return res;
                    });
                });

                const bgColor = characterMap[charName] || "#ffffff";
                const dialogueId = `dialogue-${i-1}`;
                
                outputHtml += `
                    <div class="dialogue-grid" id="${dialogueId}">
                        <div class="character-box">
                            <span class="character-name" 
                                  data-index="${i-1}" 
                                  data-character="${charName}"
                                  style="background-color: ${bgColor}">
                                ${charName}
                            </span>
                            <span class="colon">:</span>
                        </div>
                        <div class="dialogue-content">${content}</div>
                    </div>`;
            }

            document.getElementById('textDisplay').innerHTML = outputHtml;
            dialogueElements = document.querySelectorAll('.dialogue-grid');
            addCharacterClickEvents();
        }

        function addCharacterClickEvents() {
            const characterNames = document.querySelectorAll('.character-name');
            characterNames.forEach((nameElement, index) => {
                nameElement.addEventListener('click', function() {
                    const dialogueIndex = parseInt(this.getAttribute('data-index'));
                    playDialogue(dialogueIndex);
                });
            });
        }

        function applyDictionary(text) {
            const keys = Object.keys(dictionary).sort((a, b) => b.length - a.length);
            let result = text;
            const placeholders = [];

            keys.forEach((key, index) => {
                const parts = key.split('@');
                const mainWord = parts[0]; 
                const context = parts.length > 1 ? parts[1] : "";
                
                const fullSearchTerm = mainWord + context;
                const regex = new RegExp(fullSearchTerm, 'g');
                const placeholder = `___PH_${index}___`;
                
                if (result.includes(fullSearchTerm)) {
                    const htmlContent = `
                        <span class="translated-word">
                            <span class="annotation-top">${dictionary[key]}</span>${mainWord}
                        </span>${context}`;
                    
                    placeholders.push({ id: placeholder, content: htmlContent });
                    result = result.replace(regex, placeholder);
                }
            });

            placeholders.forEach(ph => {
                result = result.replace(new RegExp(ph.id, 'g'), ph.content);
            });

            return result;
        }

        const audioPlayer = document.getElementById("audioPlayer");
        const timeDisplay = document.getElementById("timeDisplay");
        const loopStart = document.getElementById("loopStart");
        const loopEnd = document.getElementById("loopEnd");
        const loopButton = document.getElementById("loopButton");
        const clearButton = document.getElementById("clearButton");
        const rewind5sButton = document.getElementById("rewind5sButton");
        const rewind1sButton = document.getElementById("rewind1sButton");
        const forward1sButton = document.getElementById("forward1sButton");
        const forward5sButton = document.getElementById("forward5sButton");
        const pausePlayButton = document.getElementById("pausePlayButton");
        const toggleControlsButton = document.getElementById("toggleControlsButton");
        const floatingControls = document.getElementById("floatingControls");
        const tuaButtons = document.querySelector('.tua-buttons');

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay() {
            if (timeDisplay) {
                timeDisplay.textContent = formatTime(audioPlayer.currentTime);
            }
        }

        let customLoopStart = null;
        let customLoopEnd = null;
        let clickCount = 0;
        let isLooping = false;
        let isDialoguePlaying = false;
        let controlsVisible = true;

        const updateInterval = setInterval(updateTimeDisplay, 1000);

        timeDisplay.onclick = () => {
            if (audioPlayer.paused) {
                clickCount++;
                if (clickCount === 1) {
                    customLoopStart = audioPlayer.currentTime;
                    loopStart.textContent = formatTime(customLoopStart);
                } else if (clickCount === 2) {
                    customLoopEnd = audioPlayer.currentTime;
                    if (customLoopEnd <= customLoopStart) {
                        customLoopEnd = null;
                        loopEnd.textContent = "--:--";
                    } else {
                        loopEnd.textContent = formatTime(customLoopEnd);
                    }
                    clickCount = 0;
                }
            }
        };

        audioPlayer.ontimeupdate = function() {
            updateTimeDisplay();
            
            if (isDialoguePlaying && currentDialogueIndex < dialogueTimings.length) {
                const timing = dialogueTimings[currentDialogueIndex];
                if (audioPlayer.currentTime >= timing.end) {
                    stopDialogue();
                }
            }
            
            if (isLooping && customLoopStart !== null && customLoopEnd !== null) {
                if (audioPlayer.currentTime >= customLoopEnd) {
                    audioPlayer.currentTime = customLoopStart;
                }
            }
        };

        function playDialogue(index) {
            if (index >= 0 && index < dialogueTimings.length) {
                stopDialogue();
                currentDialogueIndex = index;
                const timing = dialogueTimings[currentDialogueIndex];
                
                audioPlayer.currentTime = timing.start;
                audioPlayer.play();
                
                isDialoguePlaying = true;
                pausePlayButton.textContent = "停";
                highlightCharacterName(index, true);
            }
        }

        function stopDialogue() {
            audioPlayer.pause();
            pausePlayButton.textContent = "播";

            document.querySelectorAll('.character-name').forEach(name => {
                name.classList.remove('playing');
            });

            isDialoguePlaying = false;
        }

        function highlightCharacterName(index, isPlaying) {
            const characterNames = document.querySelectorAll('.character-name');
            characterNames.forEach((name, i) => {
                name.classList.remove('playing');
                if (i === index && isPlaying) {
                    name.classList.add('playing');
                }
            });
        }

        rewind5sButton.onclick = () => { if (!isLooping) audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 5); updateTimeDisplay(); };
        rewind1sButton.onclick = () => { if (!isLooping) audioPlayer.currentTime = Math.max(0, audioPlayer.currentTime - 1); updateTimeDisplay(); };
        forward1sButton.onclick = () => { if (!isLooping) audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 1); updateTimeDisplay(); };
        forward5sButton.onclick = () => { if (!isLooping) audioPlayer.currentTime = Math.min(audioPlayer.duration, audioPlayer.currentTime + 5); updateTimeDisplay(); };

        pausePlayButton.onclick = () => {
            if (audioPlayer.paused) {
                audioPlayer.play();
                pausePlayButton.textContent = "停";
                if (isDialoguePlaying) highlightCharacterName(currentDialogueIndex, true);
            } else {
                audioPlayer.pause();
                pausePlayButton.textContent = "播";
                if (isDialoguePlaying) stopDialogue();
            }
        };

        loopButton.onclick = () => {
            if (customLoopStart !== null && customLoopEnd !== null) {
                audioPlayer.currentTime = customLoopStart;
                audioPlayer.play();
                isLooping = true;
                rewind5sButton.disabled = true;
                rewind1sButton.disabled = true;
                forward1sButton.disabled = true;
                forward5sButton.disabled = true;
                pausePlayButton.textContent = "停";
            }
        };

        clearButton.onclick = () => {
            customLoopStart = null;
            customLoopEnd = null;
            loopStart.textContent = "--:--";
            loopEnd.textContent = "--:--";
            clickCount = 0;
            isLooping = false;
            rewind5sButton.disabled = false;
            rewind1sButton.disabled = false;
            forward1sButton.disabled = false;
            forward5sButton.disabled = false;
        };

        toggleControlsButton.onclick = () => {
            if (controlsVisible) {
                timeDisplay.style.display = "none";
                tuaButtons.style.display = "none";
                pausePlayButton.style.display = "none";
                loopStart.style.display = "none";
                loopEnd.style.display = "none";
                loopButton.style.display = "none";
                clearButton.style.display = "none";
                toggleControlsButton.textContent = "示";
                controlsVisible = false;
            } else {
                timeDisplay.style.display = "inline-block";
                tuaButtons.style.display = "flex";
                pausePlayButton.style.display = "inline-flex";
                loopStart.style.display = "inline-block";
                loopEnd.style.display = "inline-block";
                loopButton.style.display = "inline-flex";
                clearButton.style.display = "inline-flex";
                toggleControlsButton.textContent = "藏";
                controlsVisible = true;
            }
        };

        audioPlayer.onpause = audioPlayer.onended = function() {
            pausePlayButton.textContent = "播";
            stopDialogue();
        };

        function loadQuiz() {
            const questionsDiv = document.getElementById('questions');
            questionsDiv.innerHTML = '';
            quizData.forEach((item, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.textContent = `Câu ${index + 1}: ${item.question}`;
                if (userSelections[index] === true) questionDiv.classList.add('selected');
                questionDiv.onclick = () => {
                    questionDiv.classList.toggle('selected');
                    userSelections[index] = questionDiv.classList.contains('selected');
                };
                questionsDiv.appendChild(questionDiv);
            });
        }

        function checkAnswers() {
            let score = 0;
            const total = quizData.length;
            let wrongAnswers = [];

            quizData.forEach((item, index) => {
                const userAnswer = userSelections[index] === true;
                const correctAnswer = item.correct;

                if (userAnswer === correctAnswer) {
                    score++;
                } else {
                    const userChoice = userAnswer ? "正确" : "错误";
                    const correctChoice = correctAnswer ? "正确" : "错误";
                    wrongAnswers.push({
                        num: index + 1,
                        content: item.question,
                        user: userChoice,
                        correct: correctChoice
                    });
                }
            });

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `<h3>结果: ${score}/${total} 正确 (${(score/total * 100).toFixed(2)}%)</h3>`;

            if (wrongAnswers.length === 0) {
                resultDiv.innerHTML += '<p style="color:#007a33; font-size:22px;">恭喜！全部正确！</p>';
            } else {
                resultDiv.innerHTML += '<h4 style="color:#f65936;">错题回顾:</h4>';
                wrongAnswers.forEach(wrong => {
                    resultDiv.innerHTML += `
                        <div class="wrong-answer">
                            第 ${wrong.num} 题: ${wrong.content}<br>
                            你的选择: <strong>${wrong.user}</strong> → 正确答案: <strong>${wrong.correct}</strong>
                        </div>`;
                });
            }

            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        const dialogueModeButton = document.getElementById('dialogueMode');
        const quizModeButton = document.getElementById('quizMode');
        const dialogueContainer = document.getElementById('dialogueContainer');
        const quizContainer = document.getElementById('quizContainer');

        dialogueModeButton.addEventListener('click', () => {
            dialogueContainer.style.display = 'flex';
            quizContainer.style.display = 'none';
            floatingControls.style.display = 'block';
            dialogueModeButton.classList.add('active');
            quizModeButton.classList.remove('active');
        });

        quizModeButton.addEventListener('click', () => {
            dialogueContainer.style.display = 'none';
            quizContainer.style.display = 'block';
            floatingControls.style.display = 'none';
            audioPlayer.pause();
            quizModeButton.classList.add('active');
            dialogueModeButton.classList.remove('active');
            loadQuiz();
            document.getElementById('result').style.display = 'none';
        });

        document.getElementById('submitQuiz').addEventListener('click', checkAnswers);

        renderText(text);
        audioPlayer.onloadedmetadata = () => updateTimeDisplay();
    </script>
</body>
</html>