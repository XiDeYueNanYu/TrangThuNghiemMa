<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typography Audio Sync</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
            color: #fff;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #text-stage {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #master-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            opacity: 0; /* Ẩn cho đến khi bắt đầu */
            transition: opacity 1s;
        }
        
        .text-line {
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            white-space: nowrap;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            will-change: transform, opacity, font-size;
            padding: 0 20px;
            transform: translateY(-50%);
        }
        
        .current-line {
            opacity: 1;
            z-index: 10;
            filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.5));
        }
        
        .old-line {
            filter: blur(2px);
            color: #666;
            opacity: 0.6;
        }

        /* Nút bắt đầu nổi */
        #start-btn {
            position: fixed;
            bottom: 40px;
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
            background: #fff;
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s;
        }

        #start-btn:hover {
            transform: scale(1.1);
            background: #00d2ff;
            color: #fff;
        }

        #start-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive cho mobile */
        @media (max-width: 768px) {
            .text-line {
                white-space: normal;
                word-wrap: break-word;
                word-break: keep-all;
                line-height: 1.2;
                padding: 0 15px;
            }
            
            .current-line {
                filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.3));
            }
            
            #start-btn {
                bottom: 20px;
                padding: 12px 30px;
                font-size: 1rem;
                left: 50%;
                transform: translateX(-50%);
            }
            
            #start-btn:hover {
                transform: translateX(-50%) scale(1.1);
            }
        }
        
        /* Cho màn hình rất nhỏ */
        @media (max-width: 480px) {
            .text-line {
                padding: 0 10px;
                line-height: 1.1;
            }
        }
    </style>
</head>
<body>

    <button id="start-btn">Đang tải âm thanh...</button>

    <div id="text-stage">
        <div id="master-container"></div>
    </div>

    <script>
        const CONTENT_SOURCE = [`
            Linda
            tuần này 
            kế hoạch của cậu 
            thế nào?
            Hôm nay 
            là thứ Hai nhỉ? 
            Hôm nay và ngày mai 
            mình học tiếng Việt 
            ở Viện. 
            Ngày kia 
            sẽ học Vẽ 
            ở Câu lạc bộ
            Ngày kìa 
            học Đàn bầu 
            ở nhà cô Tâm
            Còn thứ Sáu 
            mình có hẹn 
            với cô giáo rồi
            Thứ Bảy và Chủ nhật 
            mình ở nhà
            Còn Mary 
            thế nào?
            Mình cũng bận lắm
            Từ thứ Hai đến thứ Sáu 
            mình đọc sách 
            ở thư viện
            Thứ Bảy mình sẽ 
            học nấu ăn 
            ở nhà chị Kim Anh
            Mình 
            thích nấu ăn lắm
            Còn
            Chủ nhật 
            mình sẽ chơi thể thao một chút
            Thế à? 
            Mary 
            biết chơi ten nít không?
            Biết
            Nhưng không giỏi lắm.
        `];

        const CONFIG = {
            padding: 20,
            maxFontSize: 120,
            minFontSize: 20,
            lineSpacing: 1.5,
            transitionTime: 400,
            mobileMaxFontSize: 80,
            mobileMinFontSize: 16
        };
        
        const stage = document.getElementById('master-container');
        const startBtn = document.getElementById('start-btn');
        const audio = new Audio('hoithoai.mp3'); // Tự nhận diện file cùng thư mục
        
        let lineElements = [];
        let currentIndex = 0;
        let globalFontSize = 0;
        let linesWithTiming = [];
        let totalDuration = 0;
        let isMobile = window.innerWidth <= 768;

        // CẬP NHẬT TRẠNG THÁI MOBILE KHI RESIZE
        function updateMobileStatus() {
            isMobile = window.innerWidth <= 768;
        }

        // 1. CHỜ AUDIO LOAD ĐỂ LẤY THỜI GIAN
        audio.addEventListener('loadedmetadata', () => {
            totalDuration = audio.duration;
            startBtn.textContent = "Bắt đầu";
            prepareLines();
        });

        // Xử lý lỗi nếu không tìm thấy file audio
        audio.addEventListener('error', () => {
            console.error("Không tìm thấy file hoithoai.mp3. Sử dụng thời gian mặc định 60s.");
            totalDuration = 60; 
            startBtn.textContent = "Bắt đầu (Không có âm thanh)";
            prepareLines();
        });

        function prepareLines() {
            const rawLines = CONTENT_SOURCE[0]
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            const totalChars = rawLines.reduce((acc, line) => acc + line.length, 0);

            linesWithTiming = rawLines.map(line => {
                const ratio = line.length / totalChars;
                return {
                    text: line,
                    displayTime: ratio * totalDuration * 1000 
                };
            });
        }

        function calculateFontSize(text) {
            // Lấy kích thước màn hình hiện tại
            const screenWidth = window.innerWidth;
            const isMobileNow = screenWidth <= 768;
            
            // Thiết lập giới hạn kích thước chữ
            const maxSize = isMobileNow ? CONFIG.mobileMaxFontSize : CONFIG.maxFontSize;
            const minSize = isMobileNow ? CONFIG.mobileMinFontSize : CONFIG.minFontSize;
            
            // Tính chiều rộng có thể sử dụng (trừ padding)
            const usableWidth = screenWidth - (CONFIG.padding * 2);
            
            if (isMobileNow) {
                // Trên mobile: tính font size để vừa với chiều rộng
                // Ước tính mỗi ký tự chiếm khoảng 0.6 lần font size (tùy chỉnh)
                const approxCharWidth = 0.6;
                let fontSize = Math.floor(usableWidth / (text.length * approxCharWidth));
                
                // Giới hạn font size
                fontSize = Math.max(minSize, Math.min(maxSize, fontSize));
                
                // Đảm bảo không quá nhỏ
                return fontSize;
            } else {
                // Trên desktop: giữ logic cũ
                let idealSize = Math.floor(usableWidth / (text.length * 0.6));
                return Math.max(minSize, Math.min(maxSize, idealSize));
            }
        }

        function getLinePosition(index, fontSize) {
            const viewportHeight = window.innerHeight;
            
            if (isMobile) {
                // Trên mobile: dòng hiện tại luôn ở giữa màn hình
                // Các dòng cũ dịch lên trên
                if (index === lineElements.length - 1) {
                    // Dòng hiện tại
                    return viewportHeight * 0.5;
                } else {
                    // Các dòng cũ
                    const distance = lineElements.length - 1 - index;
                    const offset = distance * (fontSize * CONFIG.lineSpacing * 0.8);
                    return (viewportHeight * 0.5) - offset;
                }
            } else {
                // Trên desktop: logic cũ
                const centerY = viewportHeight / 2;
                const distance = lineElements.length - 1 - index;
                const offset = distance * (fontSize * CONFIG.lineSpacing);
                return centerY - offset;
            }
        }

        function updateStage() {
            // Cập nhật trạng thái mobile
            updateMobileStatus();
            
            // Chỉ tính lại font size cho dòng hiện tại
            if (lineElements.length > 0) {
                const currentLineObj = lineElements[lineElements.length - 1];
                globalFontSize = calculateFontSize(currentLineObj.text);
            }

            // Cập nhật tất cả các dòng
            lineElements.forEach((lineObj, index) => {
                const { element } = lineObj;
                const distance = lineElements.length - 1 - index;
                
                // Áp dụng font size
                element.style.fontSize = `${globalFontSize}px`;
                
                // Tính vị trí
                const targetY = getLinePosition(index, globalFontSize);
                element.style.top = `${targetY}px`;
                
                // Điều chỉnh opacity
                if (isMobile) {
                    element.style.opacity = distance === 0 ? 1 : Math.max(0.3, 0.9 - distance * 0.2);
                } else {
                    element.style.opacity = distance === 0 ? 1 : Math.max(0, 1 - distance * 0.35);
                }
                
                // Thêm/loại bỏ class
                element.classList.toggle('current-line', distance === 0);
                element.classList.toggle('old-line', distance > 0);

                // Xóa dòng khi ra khỏi màn hình (chỉ trên mobile)
                if (isMobile && targetY < -100) {
                    setTimeout(() => {
                        if (element.parentNode) {
                            element.remove();
                            lineElements = lineElements.filter(item => item.element !== element);
                        }
                    }, CONFIG.transitionTime);
                }
            });
        }

        function next() {
            if (currentIndex >= linesWithTiming.length) {
                return; // Kết thúc khi hết bài
            }

            const currentData = linesWithTiming[currentIndex];
            
            const el = document.createElement('div');
            el.className = 'text-line';
            el.textContent = currentData.text;
            
            // Đặt vị trí ban đầu ở dưới màn hình
            el.style.top = `${window.innerHeight + 100}px`;
            el.style.opacity = '0';
            
            stage.appendChild(el);

            lineElements.push({ element: el, text: currentData.text });
            
            // Cập nhật hiển thị
            setTimeout(() => {
                updateStage();
            }, 50);
            
            currentIndex++;

            setTimeout(next, currentData.displayTime);
        }

        // SỰ KIỆN BẮT ĐẦU
        startBtn.addEventListener('click', () => {
            startBtn.style.display = 'none';
            stage.style.opacity = '1';
            audio.play();
            next();
        });

        // XỬ LÝ RESIZE VỚI DEBOUNCE
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateMobileStatus();
                if (lineElements.length > 0) {
                    updateStage();
                }
            }, 250);
        });

        // XỬ LÝ ORIENTATION CHANGE
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                updateMobileStatus();
                if (lineElements.length > 0) {
                    updateStage();
                }
            }, 300);
        });
    </script>
</body>
</html>