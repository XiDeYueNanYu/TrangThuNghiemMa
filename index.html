<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typography Audio Sync - Original Effect Restored</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: radial-gradient(circle at center, #1b2735 0%, #090a0f 100%);
            color: #fff;
            font-family: 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        #master-container { width: 100vw; height: 100vh; position: relative; overflow: hidden; }
        
        .text-line {
            position: absolute;
            left: 0; right: 0;
            text-align: center;
            font-weight: 800;
            text-transform: uppercase;
            transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            will-change: transform, opacity, top, font-size;
            display: flex; justify-content: center; align-items: flex-end;
            white-space: nowrap;
        }

        /* Logic bản dịch đồng bộ chân chữ */
        .word-wrapper {
            display: inline-flex; flex-direction: column; align-items: center;
            justify-content: flex-end; margin: 0 0.12em; vertical-align: bottom;
        }
        .translation {
            font-size: 0.45em; line-height: 1; color: #00d2ff;
            text-transform: none; font-weight: 400;
            margin-bottom: 0.35em; min-height: 1.1em;
        }
        .old-line .translation { visibility: hidden; }
        .original { line-height: 1; }

        #control-btn {
            position: fixed; bottom: 30px; z-index: 1000;
            padding: 15px 35px; font-size: 1.1rem; font-weight: bold;
            border-radius: 50px; border: none; cursor: pointer;
            background: #fff; color: #000; transition: 0.3s;
        }
        #control-btn:hover { background: #00d2ff; color: #fff; }
    </style>
</head>
<body>

    <button id="control-btn">Đang tải...</button>
    <div id="master-container"></div>

    <script>
        const DICTIONARY = {
            "kế hoạch": "计划", "tiếng Việt": "越南语", "Câu lạc bộ": "俱乐部",
            "thư viện": "图书馆", "nấu ăn": "做饭", "thể thao": "体育",
            "ten nít": "网球", "Hôm nay": "今天"
        };

        const CONTENT = `
            Linda
tuần này 
kế hoạch của cậu 
thế nào?
Hôm nay 
là thứ Hai nhỉ? 
Hôm nay và ngày mai 
mình học tiếng Việt 
ở Viện. 
Ngày kia 
sẽ học Vẽ 
ở Câu lạc bộ
Ngày kìa 
học Đàn bầu 
ở nhà cô Tâm
Còn thứ Sáu 
mình có hẹn 
với cô giáo rồi
Thứ Bảy và Chủ nhật 
mình ở nhà
Còn Mary 
thế nào?
Mình cũng bận lắm
Từ thứ Hai đến thứ Sáu 
mình đọc sách 
ở thư viện
Thứ Bảy mình sẽ 
học nấu ăn 
ở nhà chị Kim Anh
Mình 
thích nấu ăn lắm
Còn
Chủ nhật 
mình sẽ chơi thể thao một chút
Thế à? 
Mary 
biết chơi ten nít không?
Biết
Nhưng không giỏi lắm.
        `;

        const CONFIG = {
            maxFontSize: 100,
            lineSpacing: 2.2,
            oldLineSizeMultiplier: 0.7, // Tỉ lệ dòng cũ so với dòng hiện tại
            manualDuration: 38 
        };

        const stage = document.getElementById('master-container');
        const btn = document.getElementById('control-btn');
        const audio = new Audio('hoithoai.mp3');

        let lineElements = [];
        let currentIndex = 0;
        let linesWithTiming = [];
        let isPlaying = false;
        let timer = null;
        let currentFontSize = 0; // Lưu trữ font size của dòng hiện tại

        function applyDictionary(text) {
            let temp = text;
            const sortedKeys = Object.keys(DICTIONARY).sort((a, b) => b.length - a.length);
            const matches = [];

            sortedKeys.forEach((key, i) => {
                const regex = new RegExp(key.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
                temp = temp.replace(regex, (m) => {
                    const id = `##${i}##`;
                    matches[id] = { o: m, t: DICTIONARY[key] };
                    return id;
                });
            });

            return temp.split(/\s+/).map(token => {
                const data = matches[token];
                return `<span class="word-wrapper">
                    <span class="translation">${data ? data.t : ''}</span>
                    <span class="original">${data ? data.o : token}</span>
                </span>`;
            }).join(' ');
        }

        audio.onloadedmetadata = () => {
            const lines = CONTENT.trim().split('\n').map(l => l.trim());
            const duration = CONFIG.manualDuration > 0 ? CONFIG.manualDuration : audio.duration;
            const timePerLine = (duration / lines.length) * 1000;
            linesWithTiming = lines.map(text => ({ text, time: timePerLine }));
            btn.textContent = "Bắt đầu";
        };

        function updateStage() {
            if (lineElements.length === 0) return;
            const vH = window.innerHeight;
            
            // 1. Tính toán font size cho dòng mới nhất (dòng hiện tại)
            const latestLine = lineElements[lineElements.length - 1];
            currentFontSize = Math.min(CONFIG.maxFontSize, Math.floor(window.innerWidth / (latestLine.text.length * 0.7)));

            // 2. Cập nhật tất cả các dòng dựa trên currentFontSize
            lineElements.forEach((obj, i) => {
                const distance = lineElements.length - 1 - i;
                const element = obj.element;
                
                if (distance === 0) {
                    element.style.fontSize = `${currentFontSize}px`;
                    element.className = 'text-line current-line';
                    element.style.top = `50%`;
                    element.style.opacity = '1';
                } else {
                    const oldSize = currentFontSize * CONFIG.oldLineSizeMultiplier;
                    element.style.fontSize = `${oldSize}px`;
                    element.className = 'text-line old-line';
                    // Đẩy các dòng trước lên dựa trên kích thước đã thu nhỏ
                    element.style.top = `calc(50% - ${distance * oldSize * CONFIG.lineSpacing}px)`;
                    element.style.opacity = Math.max(0, 1 - distance * 0.3);
                }
            });
        }

        function next() {
            if (!isPlaying || currentIndex >= linesWithTiming.length) return;

            const data = linesWithTiming[currentIndex];
            const el = document.createElement('div');
            el.className = 'text-line';
            el.innerHTML = applyDictionary(data.text);
            stage.appendChild(el);

            lineElements.push({ element: el, text: data.text });
            if (lineElements.length > 6) lineElements.shift().element.remove();

            updateStage();
            currentIndex++;
            timer = setTimeout(next, data.time);
        }

        btn.onclick = () => {
            if (!isPlaying) {
                isPlaying = true;
                audio.play();
                btn.textContent = "Tạm dừng";
                // Nếu đang ở giữa chừng, gọi lại timer
                if (currentIndex < linesWithTiming.length) {
                   next();
                }
            } else {
                isPlaying = false;
                audio.pause();
                btn.textContent = "Tiếp tục";
                if (timer) clearTimeout(timer);
            }
        };

        audio.onended = () => {
            isPlaying = false;
            btn.textContent = "Bắt đầu lại";
            currentIndex = 0;
            lineElements = [];
            stage.innerHTML = '';
            if (timer) clearTimeout(timer);
        };

        window.onresize = updateStage;
    </script>
</body>
</html>